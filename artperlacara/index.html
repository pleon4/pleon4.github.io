<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>face-api amb càmeres i visualitzacions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.3/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ml5js/Intro-ML-Arts-IMA@ml5-build-10-7-19/ml5_build/ml5.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f4f4f4;
      }
      #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-family: Arial, sans-serif;
        font-size: 18px;
        color: #333;
        z-index: 10;
      }
      .loader {
        width: 50px;
        height: 50px;
        border: 6px solid #3498db;
        border-top: 6px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #canvas-main {
        border: 2px solid #2c2c2c;
      }
      #canvas-points {
        border: 2px solid #2c2c2c;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div id="loading-screen">
      <div class="loader"></div>
      <p>Carregant models, si us plau, espera...</p>
    </div>

    <script>
      let faceapi;
      let detections = [];
      let video;
      let mainCanvas;
      let pointsCanvas;
      let modelsMostrats = false;
      let obraImg;

      function preload() {
        obraImg = loadImage("El beso de klimr.avif"); // Assegura't que aquest fitxer està al mateix lloc
      }

      function setup() {
        mainCanvas = createCanvas(480, 480);
        mainCanvas.id("canvas-main");

        pointsCanvas = createGraphics(600, 600);
        pointsCanvas.canvas.id = "canvas-points";
        pointsCanvas.canvas.style.display = "block";
        pointsCanvas.canvas.style.margin = "20px auto";

        video = createCapture(VIDEO);
        video.id("video");
        video.size(480, 480);
        video.hide();

        const faceOptions = {
          withLandmarks: true,
          withExpressions: true,
          withDescriptors: true,
          minConfidence: 0.5
        };

        faceapi = ml5.faceApi(video, faceOptions, faceReady);
      }

      function faceReady() {
        faceapi.detect(gotFaces);
      }

      function gotFaces(error, result) {
        if (error) {
          console.log(error);
          return;
        }
        detections = result;

        if (!modelsMostrats) {
          document.getElementById("loading-screen").style.display = "none";
          modelsMostrats = true;
        }

        faceapi.detect(gotFaces);
      }

      function draw() {
        image(video, 0, 0, width, height);

        if (detections && detections.length > 0) {
          drawOverlay(detections);
        }

        pointsCanvas.clear();
        if (detections && detections.length > 0) {
          drawBigFace(pointsCanvas, detections[0]);
        }
      }

      function drawOverlay(detections) {
        for (let f = 0; f < detections.length; f++) {
          let d = detections[f];
          let box = d.alignedRect._box;

          stroke(44, 169, 225);
          strokeWeight(2);
          noFill();
          rect(box._x, box._y, box._width, box._height);

          let points = d.landmarks.positions;
          for (let i = 0; i < points.length; i++) {
            fill(255, 0, 0);
            noStroke();
            ellipse(points[i]._x, points[i]._y, 5, 5);
          }

          let expr = d.expressions;
          let dominant = Object.keys(expr).reduce((a, b) => expr[a] > expr[b] ? a : b);
          noStroke();
          fill(44, 169, 225);
          textSize(16);
          textFont('Helvetica Neue');
          text("Expressió: " + dominant, 10, height - 20);
        }
      }

      function drawBigFace(pg, detection) {
        let expr = detection.expressions;
        let dominant = Object.keys(expr).reduce((a, b) => expr[a] > expr[b] ? a : b);

        if (dominant === "happy") {
          pg.tint(255); // Sense filtre
          pg.image(obraImg, 0, 0, pg.width, pg.height);
        } else if (dominant === "sad") {
          pg.tint(100, 100, 255); // Filtre blau
          pg.image(obraImg, 0, 0, pg.width, pg.height);
        } else {
          // Dibuix alternatiu si no és ni feliç ni trist
          let cx = pg.width / 2;
          let cy = pg.height / 2;
          let faceSize = 300;

          pg.noTint();
          pg.fill(255);
          pg.stroke(0);
          pg.ellipse(cx, cy, faceSize, faceSize);
          pg.fill(0);
          pg.ellipse(cx - faceSize / 5, cy - faceSize / 5, 30, 30);
          pg.ellipse(cx + faceSize / 5, cy - faceSize / 5, 30, 30);
          pg.noFill();
          pg.strokeWeight(4);
          pg.stroke(0);
          pg.line(cx - 70, cy + faceSize / 8, cx + 70, cy + faceSize / 8);
          pg.noStroke();
          pg.fill(44, 169, 225);
          pg.textSize(24);
          pg.textAlign(CENTER, CENTER);
          pg.text("Expressió: " + dominant, cx, cy + faceSize / 2 + 30);
        }
      }
    </script>
  </body>
</html>
